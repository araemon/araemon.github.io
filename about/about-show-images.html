<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>
画像表示について</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta content="画像表示について" property="og:title" />
<meta content="article" property="og:type" />
<meta content="https://araemon.github.io/about/about-show-images.html" property="og:url" />
<meta content="https://araemon.github.io/images/pagespeed-insight.jpg" property="og:image" />
<link rel="stylesheet" type="text/css" href="/css/icon.css"  />
<link rel="stylesheet" type="text/css" href="/css/main.css?1545372821"  />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-icon-144x144.jpg">
<link rel="shortcut icon" href="/images/favicon.ico">
</head>
<body>

        <div id="container">
        <div id="header" class="about">
        <div class="layerTransparent">
                <div class="container">
                <ul class="nav">
<li><a href="/blog/">Blog</a></li>
<li><a href="/kamityping/">KamiTyping</a></li>
<li><a href="/chazuke/">Chazuke</a></li>
<li><a href="/harmonize/">Harmonize</a></li>
<li><a href="/apps/">Other Apps</a></li>
<li><a href="/oss/">OSS</a></li>
<li><a href="/about/">About</a></li>
</ul>
<div class="copyright">Copyright © Toshihiko Arai</div>
                </div>
</div>
        </div>

<div id="contents">
<article>
    <div class="tag">
    <a href="/about/" class="tagHighlight">About</a>
    </div>
<h1>
画像表示について</h1>
<div class="time"><time pubdate="" datetime="2018-12-16">
2018-12-16</time></div>
<p>

サイトの表示速度改善にはGoogleの「PageSpeed Insights」が便利です。<br><a href="https://developers.google.com/speed/pagespeed/insights/?hl=ja">https://developers.google.com/speed/pagespeed/insights/?hl=ja</a><br><br>静的コンテンツの場合、そもそも表示速度が速いので高得点が出やすいと思いますが、それでも画像に関しては軽量化などの工夫を行ってあげる必要があります。格安SIMなどの遅い回線でもサイトをストレスなく表示するためには、こういった最適化は必須となるでしょう。<br><br>次のように画像を軽量化する処理を、シェルスクリプトで実装しました。<br>まずはpngファイルをjpgに変換する処理です。<br><pre class='code'><span>for file in $( ls ${gitDir}/images/ | grep .png$ ); do
</span><span>  name=${file%.*}
</span><span>  convert ${gitDir}/images/${file} -flatten ${gitDir}/images/${name}.jpg
</span><span>  rm -f ${gitDir}/images/${file}
</span><span>done
</span></pre><br>そしてjpgファイルを、見た目に影響が出ない程度に圧縮してあげます。これで元画像の数分の一の容量になりました。<br><pre class='code'><span>for file in $( ls ${gitDir}/images/ | grep .jpg$ ); do
</span><span>  convert ${gitDir}/images/${file} -sampling-factor 4:2:0 -strip -quality 85 -interlace JPEG -colorspace sRGB ${gitDir}/images/${file}
</span><span>done
</span></pre><br>画像の最適化ができたところで、さらに初期表示速度を改善するには、現在表示されいている以外の部分の画像を、必要になった時に遅延して読み込ませるのが良いでしょう。<br>そこで画像を遅延読み込みさせることのできるjavascriptのライブラリ「Lazy Load」を使ってみました。jqueryに対応していますが、jqueryがなくても動きました。<br><a href="https://github.com/tuupola/jquery_lazyload">https://github.com/tuupola/jquery_lazyload</a><br><br>Lazy Loadを使うには、遅延読み込みさせたい画像URLをdata-srcという属性に置き換える必要があります。<br><pre class='code'><span>&lt;img data-src=&quot;/images/research-is.jpg&quot; class=&quot;default lazyload&quot; /&gt;
</span></pre><br>そしてjsライブラリのパスを埋め込みます。<br><pre class='code'><span>&lt;script src=&quot;https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js&quot;&gt;&lt;/script&gt;
</span></pre><br>最後に、lazyload()を叩けば画像が遅延読み込みされるようになります。<br><pre class='code'><span>&lt;script&gt;
</span><span>lazyload();
</span><span>&lt;/script&gt;
</span></pre><br>さて、これで「PageSpeed Insights」で高得点を出すことができました。<br><img data-src="/images/pagespeed-insight.jpg" class="default lazyload" /><br></p>
</article>
</div>
            </div>
<script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
<script>
/****************************************
 * Lazy Load
***************************************/
lazyload();

</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-12032595-16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-12032595-16');
</script>

</body>
</html>