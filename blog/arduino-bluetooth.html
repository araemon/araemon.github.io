<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>
ArduinoでBluetooth通信してみた</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" type="text/css" href="/css/icon.css"  />
<link rel="stylesheet" type="text/css" href="/css/main.css?1544524394"  />
<link href="https://fonts.googleapis.com/css?family=Corben:700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c:900" rel="stylesheet">
<style>


</style>
</head>
<body>

        <div id="container">
        <div id="header" class="blog">
        <div class="layerTransparent">
                <div class="container">
                <ul class="nav">
<li><a href="/">Home</a></li>
<li><a href="/blog/">Blog</a></li>
<li><a href="/kamityping/">KamiTyping</a></li>
<li><a href="/chazuke/">Chazuke S</a></li>
<li><a href="/harmonize/">Harmonize</a></li>
<li><a href="/contact/">Contact</a></li>
</ul>
<div class="copyright">Copyright © Toshihiko Arai</div>
                </div>
</div>
        </div>

<div id="contents">
<article>
<a href="/blog/">[Blog]</a>
<h1>
ArduinoでBluetooth通信してみた</h1>
<div class="time"><time pubdate="" datetime="2018-11-19">
2018-11-19</time></div>

        <ul class="shareList">
        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=http://192.168.100.101/blog/arduino-bluetooth.html&text=Arduino%E3%81%A7Bluetooth%E9%80%9A%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F" target="_blank" title="Twitter"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="Facebook"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="Google+"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="はてなブックマーク"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=http://192.168.100.101/blog/arduino-bluetooth.html&title=Arduino%E3%81%A7Bluetooth%E9%80%9A%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F" target="_blank" title="Pocket"></a></li>
        </ul>
<p>
<h2>Bluetoothモジュールを秋葉原まで買いに行く</h2><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181119/20181119170038.jpg" class="default" /><br><br>ほとんど手をつけずに眠っていた、Arduino Unoスターターキット。<br>アプリ開発の息抜きに、温度センサーで遊んでみる。<br><br>先日キャンプで、寝るときの寒さに死ぬ思いをしたので、テント内とテント外の温度変化的なものをログれれば、などと考えているのである。<br>Arduinoにはタイムスタンプがないので（できないことはないのだが）、温度データーをスマホに飛ばしてスマホのunixtimeスタンプを使うことにする。<br>通信は、Wifi、Bluetooth、はたまたライン入力を使った音声データでのシリアル通信などを考えたが（FM変調的な）、汎用性を考えると素直にBluetoothを使った方が良さそうである。<br><br>ところで、プログラミングのような不健康で孤独な作業には、適度な運動が必要だ。<br>そんな口実をイチイチつけ、Bluetoothモジュールを買いに秋葉原まで歩くことにした。<br>赤羽から秋葉原までは二時間程度、意外と近い。<br><br><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181119/20181119165002.jpg" width="300" /><br><br>GoogleMapのチートは２回だけ、ほぼカンで歩いた。<br>田端あたりの土地勘がないため、焦りが形跡に出ていて面白い。<br>今度行くとしたら東大経由または上野経由が面白そうだな。<br>秋月電子、千石電商と回った。千石電商で小一時間、悩む。<br>結局このBluefruit LE UART Friendを2100円で購入。<br><br><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181119/20181119170040.jpg" width="300" /><br><br>ググってみると英語のみの情報しかないので辛いが、まぁなんとかなることでしょう。<br>付近の萌え萌えキュンにはあえて目もくれてやらず、安定のケバブを食べ、硬派を気取りそそくさと帰途につく。<br><br><br><br><h2>BluetoothモジュールからのメッセージをiPhoneで受信する</h2>まずは、Bluefruitの半田付け。<br>ピンを数カ所やるだけなので、物足りない半田付け作業だ。<br><br>トライアンドエラーでやっていくうちに、配線はこうなった。<br><br>| Bluefruit | Arduino    |<br>| --------- | ---------- |<br>| DFU       | 未接続     |<br>| GND       | GND        |<br>| RTS       | 未接続     |<br>| VIN       | 5V         |<br>| RXI       | DIGITAL 9  |<br>| TXO       | DIGITAL 10 |<br>| CTS       | DIGITAL 11 |<br>| MOD       | 未接続     |<br><br>また、スイッチはUART側にしておく。<br><br>スマホからBluefruitに接続する専用のアプリがあるのでインストールする。<br><a href="https://itunes.apple.com/jp/app/adafruit-bluefruit-le-connect/id830125974?mt=8&amp;uo=4">https://itunes.apple.com/jp/app/adafruit-bluefruit-le-connect/id830125974?mt=8&amp;uo=4</a><br><a href="https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect">https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect</a><br><br>Arduinoにプログラムを書き込まなくても電源を入れれば、Bluefruitとは接続できる。<br><br><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181120/20181120101723.jpg" width="300" /><br><br>今度はArduinoのIDE側の設定をしていく。<br><br>Bluefruit LE UART Friendの情報はこちら。<br><a href="https://learn.adafruit.com/introducing-the-adafruit-bluefruit-le-uart-friend/introduction">https://learn.adafruit.com/introducing-the-adafruit-bluefruit-le-uart-friend/introduction</a><br><br>英語の情報できついが、なんとかやっていく。<br><br>サンプルコード（Adafruit_BluefruitLE_nRF51）をダウンロードする。<br><a href="https://learn.adafruit.com/introducing-the-adafruit-bluefruit-le-uart-friend/software">https://learn.adafruit.com/introducing-the-adafruit-bluefruit-le-uart-friend/software</a><br><br>解凍したらフォルダ名をAdafruit_BluefruitLE_nRF51にしてArduinoのライブラリフォルダに取り入れる。<br>場所はDocuments -> Arduino -> librariesになっていると思う。<br>これでArduino IDEのスケッチ例の中にAdafruit_BluefruitLE_nRF51のサンプルコードが入った。<br><br>サンプルコードを元に改造していく。<br>いらなそうなものは削って見やすくすると仕組みが分かってくる。<br>こちらは「debug」という文字を1秒間に一回、アプリへ送信するだけのプログラムだ。<br><br><pre><br>#include <Arduino.h><br>#include <SPI.h><br>#include "Adafruit_BLE.h"<br>#include "Adafruit_BluefruitLE_SPI.h"<br>#include "Adafruit_BluefruitLE_UART.h"<br><br><br>#if SOFTWARE_SERIAL_AVAILABLE<br>  #include <SoftwareSerial.h><br>#endif<br><br>// Arduino UNOの場合この設定でうまくいった<br>//<br>#define BLUEFRUIT_SWUART_RXD_PIN       9    // Required for software serial!<br>#define BLUEFRUIT_SWUART_TXD_PIN       10   // Required for software serial!<br>#define BLUEFRUIT_UART_CTS_PIN         11   // Required for software serial!<br>#define BLUEFRUIT_UART_RTS_PIN         -1    // Optional, set to -1 if unused<br>#define BLUEFRUIT_UART_MODE_PIN        -1    // Set to -1 if unused<br>#define VERBOSE_MODE                   true  // If set to 'true' enables debug output<br><br>SoftwareSerial bluefruitSS = SoftwareSerial(BLUEFRUIT_SWUART_TXD_PIN, BLUEFRUIT_SWUART_RXD_PIN);<br><br>Adafruit_BluefruitLE_UART ble(bluefruitSS, BLUEFRUIT_UART_MODE_PIN,<br>                      BLUEFRUIT_UART_CTS_PIN, BLUEFRUIT_UART_RTS_PIN);<br><br><br>void error(const __FlashStringHelper*err) {<br>  Serial.println(err);<br>  while (1);<br>}<br><br><br>void setup(void)<br>{<br>  while (!Serial); // required for Flora & Micro<br>  delay(500);<br><br><br>  Serial.begin(9600);<br><br>  if ( !ble.begin(VERBOSE_MODE) )<br>  {<br>    error(F("Couldn't find Bluefruit, make sure it's in CoMmanD mode & check wiring?"));<br>  }<br>  Serial.println( F("OK!") );<br><br>}<br><br>void loop(void)<br>{<br>  delay(1000);<br>  ble.write("debug\n");<br>}<br></pre><br><br>結果を見てみよう。<br><br><iframe width="560" height="315" frameborder="0" allowfullscreen="" src="//www.youtube.com/embed/ji9QMKKZXmk"></iframe><br><a href="https://youtube.com/watch?v=ji9QMKKZXmk">Success! Connecting Arduino and smartphone with Bluetooth.</a><br><br>みごと、接続成功！⚡️<br><br><br><h2>iOSとArudinoのBluetooth通信</h2>今度はiOSからArduinoへメッセージを投げて、さらにそのメッセージをArduinoから受け取ってみる。<br><br><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181121/20181121164901.jpg" class="default" /><br><br>Swiftでこんな感じのiOSアプリを作ってみることにした。<br>これができるようになればBluetoothでArduinoからデータを読み込んだり、Arduinoを操作したりすることができるようになる。<br><br><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20181121/20181121165524.jpg" width="300" /><br><br><br><pre><br>import UIKit<br>import CoreBluetooth<br><br>class ViewController: UIViewController {<br><br>    @IBOutlet weak var reciveTextView: UITextView!<br>    <br>    <br>    let kUARTServiceUUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E" // UARTサービス<br>    let kTXCharacteristicUUID = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E" // ペリフェラルへ送信用<br>    let kRXCharacteristicUUID = "6E400003-B5A3-F393-E0A9-E50E24DCCA9E" // ペリフェラルからの受信用<br><br>    var centralManager: CBCentralManager!<br>    var peripheral: CBPeripheral!<br>    var serviceUUID : CBUUID!<br>    var kTXCBCharacteristic: CBCharacteristic!<br>    var kRXCBCharacteristic: CBCharacteristic!<br>//    var charcteristicUUID: CBUUID!<br>    var charcteristicUUIDs: [CBUUID]!<br>    <br>    @IBOutlet weak var sendMessageTextField: UITextField!<br>    @IBAction func clickedConnectButton(_ sender: Any) {<br>        setup()<br>    }<br>    <br><br>    @IBAction func clickedWriteButton(_ sender: Any) {<br>        let peripheral = self.peripheral<br>        if(peripheral == nil) { return }<br>        <br>        let writeData = sendMessageTextField.text!.data(using: .utf8)!<br>        peripheral!.writeValue(writeData, for: kTXCBCharacteristic, type: .withResponse)<br>        sendMessageTextField.text = ""<br>    }<br>    <br><br>    <br>    override func viewDidLoad() {<br>        super.viewDidLoad()<br>        <br>    }<br><br>    /// セントラルマネージャー、UUIDの初期化<br>    private func setup() {<br>        centralManager = CBCentralManager()<br>        centralManager.delegate = self as CBCentralManagerDelegate<br>//        centralManager.scanForPeripherals(withServices: nil, options: nil)<br><br>        serviceUUID = CBUUID(string: kUARTServiceUUID)<br>        charcteristicUUIDs = [CBUUID(string: kTXCharacteristicUUID), CBUUID(string: kRXCharacteristicUUID)]<br>    }<br><br>}<br><br>//MARK : - CBCentralManagerDelegate<br>extension ViewController: CBCentralManagerDelegate {<br>    <br>    func centralManagerDidUpdateState(_ central: CBCentralManager) {<br>        <br>        switch central.state {<br>            <br>        //電源ONを待って、スキャンする<br>        case CBManagerState.poweredOn:<br>            let services: [CBUUID] = [serviceUUID]<br>            centralManager?.scanForPeripherals(withServices: services,<br>                                               options: nil)<br>        default:<br>            break<br>        }<br>    }<br>    <br>    /// ペリフェラルを発見すると呼ばれる<br>    func centralManager(_ central: CBCentralManager,<br>                        didDiscover peripheral: CBPeripheral,<br>                        advertisementData: [String : Any],<br>                        rssi RSSI: NSNumber) {<br>        <br>        self.peripheral = peripheral<br>        centralManager?.stopScan()<br>        <br>        //接続開始<br>        central.connect(peripheral, options: nil)<br>    }<br>    <br>    /// 接続されると呼ばれる<br>    func centralManager(_ central: CBCentralManager,<br>                        didConnect peripheral: CBPeripheral) {<br>        <br>        peripheral.delegate = self<br>        peripheral.discoverServices([serviceUUID])<br>    }<br>}<br><br>//MARK : - CBPeripheralDelegate<br>extension ViewController: CBPeripheralDelegate {<br>    <br>    /// サービス発見時に呼ばれる<br>    func peripheral(_ peripheral: CBPeripheral,<br>                    didDiscoverServices error: Error?) {<br>        <br>        if error != nil {<br>            print(error.debugDescription)<br>            return<br>        }<br>        <br>        //キャリアクタリスティク探索開始<br>        peripheral.discoverCharacteristics(charcteristicUUIDs,<br>                                           for: (peripheral.services?.first)!)<br>    }<br>    <br>    /// キャリアクタリスティク発見時に呼ばれる<br>    func peripheral(_ peripheral: CBPeripheral, didDiscoverCharacteristicsFor service: CBService, error: Error?) {<br>        <br>        if error != nil {<br>            print(error.debugDescription)<br>            return<br>        }<br><br>        for characteristics in service.characteristics! {<br>            if(characteristics.uuid == CBUUID(string: kTXCharacteristicUUID)) {<br>//                peripheral.setNotifyValue(true, for: (service.characteristics?[1])!)<br>                self.kTXCBCharacteristic = characteristics<br>                addMessageToTextView("Found TX characteristics !\n")<br>            } else if(characteristics.uuid == CBUUID(string: kRXCharacteristicUUID)) {<br>                self.kRXCBCharacteristic = characteristics<br>                addMessageToTextView("Found RX characteristics !\n")<br>            }<br>        }<br>        <br>        if(self.kRXCBCharacteristic != nil) {<br>            startReciving()<br>        }<br>    }<br>    <br>    private func startReciving() {<br>        peripheral.setNotifyValue(true, for: kRXCBCharacteristic)<br>        addMessageToTextView("Start monitoring the message from Arduino.\n\n")<br>    }<br><br><br>    func peripheral(_ peripheral: CBPeripheral, didWriteValueFor characteristic: CBCharacteristic, error: Error?) {<br>        print(#function)<br>        if error != nil {<br>            print(error.debugDescription)<br>            return<br>        }<br>    }<br>    <br>    /// データ更新時に呼ばれる<br>    func peripheral(_ peripheral: CBPeripheral, didUpdateValueFor characteristic: CBCharacteristic, error: Error?) {<br>        <br>        if error != nil {<br>            print(error.debugDescription)<br>            return<br>        }<br>        updateWithData(data: characteristic.value!)<br>    }<br>    <br>    private func updateWithData(data : Data) {<br>        if let dataString = String(data: data, encoding: String.Encoding.utf8) {<br>            addMessageToTextView(dataString)<br>        }<br>    }<br>    <br>    private func addMessageToTextView(_ message:String) {<br>        reciveTextView.text = reciveTextView.text + message<br>        scrollToBottom(reciveTextView)<br>    }<br>    <br>    private func scrollToBottom(_ textView:UITextView) {<br>        textView.selectedRange = NSRange(location: textView.text.count, length: 0)<br>        textView.isScrollEnabled = true<br>        <br>        let scrollY = textView.contentSize.height - textView.bounds.height<br>        let scrollPoint = CGPoint(x: 0, y: scrollY > 0 ? scrollY : 0)<br>        textView.setContentOffset(scrollPoint, animated: true)<br>    }<br>}<br></pre><br><br>Arduino側のスケッチはこうなった。<br><br><pre><br>#include <string.h><br>#include <Arduino.h><br>#include <SPI.h><br>#include "Adafruit_BLE.h"<br>#include "Adafruit_BluefruitLE_SPI.h"<br>#include "Adafruit_BluefruitLE_UART.h"<br><br><br>#if SOFTWARE_SERIAL_AVAILABLE<br>  #include <SoftwareSerial.h><br>#endif<br><br>// Arduino UNOの場合この設定でうまくいった<br>//<br>#define BLUEFRUIT_SWUART_RXD_PIN       9    // Required for software serial!<br>#define BLUEFRUIT_SWUART_TXD_PIN       10   // Required for software serial!<br>#define BLUEFRUIT_UART_CTS_PIN         11   // Required for software serial!<br>#define BLUEFRUIT_UART_RTS_PIN         -1    // Optional, set to -1 if unused<br>#define BLUEFRUIT_UART_MODE_PIN        -1    // Set to -1 if unused<br>#define VERBOSE_MODE                   false  // If set to 'true' enables debug output<br><br>SoftwareSerial bluefruitSS = SoftwareSerial(BLUEFRUIT_SWUART_TXD_PIN, BLUEFRUIT_SWUART_RXD_PIN);<br><br>Adafruit_BluefruitLE_UART ble(bluefruitSS, BLUEFRUIT_UART_MODE_PIN,<br>                      BLUEFRUIT_UART_CTS_PIN, BLUEFRUIT_UART_RTS_PIN);<br><br><br><br>void error(const __FlashStringHelper*err) {<br>  Serial.println(err);<br>  while (1);<br>}<br><br><br><br>void setup(void)<br>{<br>  while (!Serial); // required for Flora & Micro<br>  delay(500);<br><br><br>  Serial.begin(9600);<br><br>  if ( !ble.begin(VERBOSE_MODE) )<br>  {<br>    error(F("Couldn't find Bluefruit, make sure it's in CoMmanD mode & check wiring?"));<br>  }<br>  Serial.println( F("OK!") );<br>}<br><br><br>void loop(void)<br>{<br><br>  int n = 0;<br>  int maxMessageLength = 50;<br>  char recivedMessage[maxMessageLength];<br><br>   while ( ble.available() ) {    <br>    int c = ble.read();<br>    // 起動時に255(0xFF)の出力をスルー<br>    if(c != 0xFF) {<br>      if(maxMessageLength > (n - 1)) {<br>        recivedMessage[n] = (char)c;<br>        n++;<br>      }<br>    }<br>  }<br><br>  if(n > 0) {<br>    recivedMessage[n] = '\0';<br>    ble.write("Arduino got your message is...\n");<br>    ble.write(recivedMessage);<br>    ble.write("\n");<br>  }<br><br>  <br>}<br></pre><br><br>見事、対話に成功した！<br><br><iframe width="560" height="315" frameborder="0" allowfullscreen="" src="//www.youtube.com/embed/bH0tcbTb9Pw"></iframe><br><a href="https://youtube.com/watch?v=bH0tcbTb9Pw">Successfully talked with iOS and Arduino on a Bluetooth connection!</a><br><br><br><h3>参考</h3>SwiftのBluetooth処理の大部分はこちらを参考にさせていただいた。<br><a href="https://qiita.com/eKushida/items/def628e0eff6c106d467">https://qiita.com/eKushida/items/def628e0eff6c106d467</a><br><br>UUIDはbluefruitのサイトに記されている。<br><a href="https://learn.adafruit.com/getting-started-with-the-nrf8001-bluefruit-le-breakout/adding-app-support">https://learn.adafruit.com/getting-started-with-the-nrf8001-bluefruit-le-breakout/adding-app-support</a><br><br>Bluetooth用語に戸惑っていたが、こちらを読めばざっくりイメージがつく。<br><a href="http://jellyware.jp/kurage/bluejelly/ble_guide.html">http://jellyware.jp/kurage/bluejelly/ble_guide.html</a><br><br></p>
        <ul class="shareList">
        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=http://192.168.100.101/blog/arduino-bluetooth.html&text=Arduino%E3%81%A7Bluetooth%E9%80%9A%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F" target="_blank" title="Twitter"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="Facebook"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="Google+"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/http://192.168.100.101/blog/arduino-bluetooth.html" target="_blank" title="はてなブックマーク"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=http://192.168.100.101/blog/arduino-bluetooth.html&title=Arduino%E3%81%A7Bluetooth%E9%80%9A%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F" target="_blank" title="Pocket"></a></li>
        </ul>

</article>
</div>
            </div>
</body>
</html>