<!DOCTYPE html>
<html lang="ja">

<head>
        <meta charset="UTF-8">
<title>CentOS 6.x に無料SSL Let's Encrypt を導入する</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-icon-144x144.jpg">
<link rel="shortcut icon" href="/images/favicon.ico">
<meta content="CentOS 6.x に無料SSL Let's Encrypt を導入する" property="og:title" />
<meta content="article" property="og:type" />
<meta content="https://araemon.github.io/blog/.html" property="og:url" />
<meta content="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20180729/20180729102849.jpg" property="og:image" />
<?php echo $SITE['article_appid']; ?>
<link rel="stylesheet" type="text/css" href="/css/icon.css" />
</head>

<body>

        <div id="container">
                <div id="header" class="blog">
                        <div class="layerTransparent">
                                <div class="container">
                                        <ul class="nav">
<li><a href="/blog/">Blog</a></li>
<li><a href="/kamityping/">KamiTyping</a></li>
<li><a href="/chazuke/">Chazuke</a></li>
<li><a href="/harmonize/">Harmonize</a></li>
<li><a href="/apps/">Other Apps</a></li>
<li><a href="/oss/">OSS</a></li>
<li><a href="/about/">About</a></li>
</ul>
<div class="copyright">Copyright © Toshihiko Arai</div>

                                </div>
                        </div>
                </div>

                <div id="contents">
                        <article>
                                <div class="tag">
                                        <a href="/blog/" class="tagHighlight">blog</a>
                                </div>
                                <h1>CentOS 6.x に無料SSL Let's Encrypt を導入する</h1>
                                <div class="time"><time pubdate="" datetime="2018-08-06">2018-08-06</time></div>
                                <p>
                                        <?php echo $SITE['article_toc']; ?>

                                        <img data-src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20180729/20180729102849.jpg" class="default lazyload" /><br>
<br>
<h2>条件</h2>
* Apacheのバージョンは2.2.15以上とする<br>
* オレオレ証明書を既に使っている<br>
* 443ポートは解放済み<br>
* バーチャルホストで運営している<br>
* CentOS 6.x<br>
<br>
この条件で以下作業を行なっていく。<br>
rootになって/rootディレクトリで操作した。<br>
<br>
<br>
<h2>手順</h2>
1. certbotをダウンロード<br>
2. Apacheを停止<br>
3. certbotを使って鍵を作成<br>
4. Apacheに鍵のパスを記述<br>
5. Apacheを再起動<br>
6. 自動更新の設定<br>
<br>
<br>
<h2>curlのアップデート</h2>
<b>curlが古いとうまくいかないので事前にアップデートしておく。</b><br>
<span class="codeInline">yum update curl</span><br>
<br>
<br>
<h2>certbotをインストール</h2>
<span class="codeInline">git clone https://github.com/letsencrypt/letsencrypt</span><br>
<br>
<br>
<h2>Apacheを停止</h2>
Apacheを止めないと証明書を作れないので止めておく。<br>
<span class="codeInline">/etc/rc.d/init.d/stop</span><br>
<br>
<br>
<h2>certbotを使って鍵を作成</h2>
いくつか質問されるが難しいことはない。<br>
<pre class="code">
./letsencrypt-auto certonly -a standalone -d hogedomain.com
</pre><br>
<br>
/etc/letsencrypt/live/hogedomain.com/ 内に鍵が作られた<br>
<br>
<pre class="code">
ls /etc/letsencrypt/live/hogedomain.com/
README  cert.pem  chain.pem  fullchain.pem  privkey.pem
</pre><br>
<br>
<h2>Apacheに鍵のパスを記述</h2>
Apacheにこの鍵のパスを設定する。<br>
<br>
<pre class="code">
vi /etc/httpd/conf.d/ssl.conf

##以下を書き換える
SSLCertificateFile /etc/letsencrypt/live/hogedomain.com/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/hogedomain.com/privkey.pem
</pre><br>
<br>
<h2>Apache 再起動</h2>
停止していたApacheを起動する。<br>
<span class="codeInline">/etc/rc.d/init.d/httpd start</span><br>
<br>
これでルートドメインにSSL付きでアクセスできる。<br>
<br>
<h2>サブドメインでもLet's Encryptを使えるようにする</h2>
サブドメイン毎に設定してやらなければならない。<br>
やり方はルートドメインの時と同じ。<br>
<span class="codeInline">./letsencrypt-auto certonly -a standalone -d sub.hogedomain.com</span><br>
<br>
<pre class="code">
vi /etc/httpd/conf.d/virtualhost.conf

##以下を追加
&amp;lt;VirtualHost *:443&amp;gt;
    ServerName sub.hogedomain.com
    DocumentRoot /somewhere/hogedomain/sub

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/sub.hogedomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/sub.hogedomain.com/privkey.pem

    ErrorLog logs/sslvirtual_error_log
    CustomLog logs/sslvirtual_access_log combined env=!no_log
   NameVirtualhost *:443
&amp;lt;/VirtualHost&amp;gt;
</pre><br>
<br>
<br>
<h2>自動更新の設定</h2>
Let's Encryptは３ヶ月しか有効期限がないので、自動更新するとよい。更新のためのコマンドをcronする。<br>
まず、下記のコマンドが正常に動作し、証明書が更新されるかをテスト。<br>
renewは、すべての証明書を更新するコマンド。--post-hookオプションで指定したコマンドは、renew後に実行される。ただし、renewは期限が迫らないうちは、実行がスキップされ、その場合はpost-hookも実行されない。<br>
<a href="https://qiita.com/takahiko/items/a08895550727b95b6c36">https://qiita.com/takahiko/items/a08895550727b95b6c36</a><br>
<br>
記事のように自動更新の設定をしていたのだが、なぜかその後に更新をしてくださいという内容のメールが来てしまった。<br>
<br>
<pre class="code">
Hello,

Your certificate (or certificates) for the names listed below will expire in 20 days (on 18 Aug 18 07:08 +0000). Please make sure to renew your certificate before then, or visitors to your website will encounter errors.

We recommend renewing certificates automatically when they have a third of their
total lifetime left. For Let's Encrypt's current 90-day certificates, that means
renewing 30 days before expiration. See
https://letsencrypt.org/docs/integration-guide/ for details.

hogehoge.com

For any questions or support, please visit https://community.letsencrypt.org/. Unfortunately, we can't provide support by email.

If you are receiving this email in error, unsubscribe at http://mandrillapp.com/track/unsub.php?u=30850198&amp;id=e6af6ce87eeb49cab9f7c4584c8d49da.Xdoz7jXx662gLBduhGy%2FwZtnakk%3D&amp;r=https%3A%2F%2Fmandrillapp.com%2Funsub%3Fmd_email%3Daraemonz%2540gmail.com

Regards,
The Let's Encrypt Team
</pre><br>
<br>
どうも、Apacheを停止してから更新処理をしていなかったのが原因のようだ。<br>
<br>
<pre class="code">
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Processing /etc/letsencrypt/renewal/hogehoge.com.conf
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Cert is due for renewal, auto-renewing...
Plugins selected: Authenticator standalone, Installer None
Renewing an existing certificate
Performing the following challenges:
tls-sni-01 challenge for hogehoge.com
Cleaning up challenges
Attempting to renew cert (hogehoge.com) from /etc/letsencrypt/renewal/hogehoge.com.conf produced an unexpected error: Problem binding to port 443: Could not bind to IPv4 or IPv6.. Skipping.
</pre><br>
<br>
ということで以下のようにcronに登録してみた。<br>
毎月の7日、04時00分に実行する。<br>
<br>
<pre class="code">
vi /etc/cron.d/letsencrypt

00 04 01 * * root /etc/rc.d/init.d/httpd stop &amp;&amp; /usr/bin/certbot-auto renew &amp;&amp; /etc/rc.d/init.d/httpd start
</pre><br>
<br>
<span class="codeInline">分 時 日 月 曜日 <実行コマンド></span><br>
<br>
<br>
<h2>faviconでエラー</h2>
ブラウザーが小さい警告表示を出していた。<br>
原因はfaviconだった。<br>
ブラウザーがfaviconを勝手にリクエストするようで、faviconを設置していなかったためにhttpでリダイレクトエラーが出たということ。<br>
faviconを設置して無事エラーはなくなった。<br>
<br>
<br>
<h2>.htaccessでhttpsへリダイレクト</h2>
<a href="httpでアクセスしても自動でhttpsへリダイレクトするように.htaccessを編集。">httpでアクセスしても自動でhttpsへリダイレクトするように.htaccessを編集。</a><br>
<br>
<pre class="code">
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</pre><br>
<br>
<a target="_blank"  href="https://www.amazon.co.jp/gp/product/4797380942/ref=as_li_tl?ie=UTF8&camp=247&creative=1211&creativeASIN=4797380942&linkCode=as2&tag=101010fun-22&linkId=872638ff825350ab40e56586340a0fd7"><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=4797380942&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=101010fun-22" ></a><img src="//ir-jp.amazon-adsystem.com/e/ir?t=101010fun-22&l=am2&o=9&a=4797380942" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /><br>

                                </p>
                                <ul class="shareList">
                                        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=https://araemon.github.io/blog/.html&text=CentOS 6.x に無料SSL Let's Encrypt を導入する"
                                                        target="_blank" title="Twitter"></a></li>
                                        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://araemon.github.io/blog/.html"
                                                        target="_blank" title="Facebook"></a></li>
                                        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=https://araemon.github.io/blog/.html"
                                                        target="_blank" title="Google+"></a></li>
                                        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/https://araemon.github.io/blog/.html"
                                                        target="_blank" title="はてなブックマーク"></a></li>
                                        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=https://araemon.github.io/blog/.html&title=CentOS 6.x に無料SSL Let's Encrypt を導入する"
                                                        target="_blank" title="Pocket"></a></li>
                                </ul>
                        </article>
                </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
        <script>
                /****************************************
                 * Lazy Load
                ***************************************/
                lazyload();

        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-12032595-16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-12032595-16');
</script>
</body>

</html>