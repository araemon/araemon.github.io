<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>
💻CentOS 6.x に無料SSL Let's Encrypt を導入する</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" type="text/css" href="/css/icon.css"  />
<link rel="stylesheet" type="text/css" href="/css/main.css?1544547617"  />
<link href="https://fonts.googleapis.com/css?family=Corben:700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c:900" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" >
<style>


</style>
</head>
<body>

        <div id="container">
        <div id="header" class="blog">
        <div class="layerTransparent">
                <div class="container">
                <ul class="nav">
<li><a href="/blog/">Blog</a></li>
<li><a href="/kamityping/">KamiTyping</a></li>
<li><a href="/chazuke/">Chazuke</a></li>
<li><a href="/harmonize/">Harmonize</a></li>
<li><a href="/apps/">Other Apps</a></li>
<li><a href="mailto:i.officearai@gmail.com">Contact</a></li>
</ul>
<div class="copyright">Copyright © Toshihiko Arai</div>
                </div>
</div>
        </div>

<div id="contents">
<article>
<a href="/blog/">Blog (記事一覧)</a>
<h1>
💻CentOS 6.x に無料SSL Let's Encrypt を導入する</h1>
<div class="time"><time pubdate="" datetime="2018-08-06">
2018-08-06</time></div>

        <ul class="shareList">
        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=http://192.168.100.101/blog/centos6-lets-encrypt.html&text=%F0%9F%92%BBCentOS+6.x+%E3%81%AB%E7%84%A1%E6%96%99SSL+Let%27s+Encrypt+%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B" target="_blank" title="Twitter"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="Facebook"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="Google+"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="はてなブックマーク"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=http://192.168.100.101/blog/centos6-lets-encrypt.html&title=%F0%9F%92%BBCentOS+6.x+%E3%81%AB%E7%84%A1%E6%96%99SSL+Let%27s+Encrypt+%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B" target="_blank" title="Pocket"></a></li>
        </ul>
<p>
<ul id="toc"><li><a href="#1">条件</a></li><li><a href="#2">手順</a></li><li><a href="#3">curlのアップデート</a></li><li><a href="#4">certbotをインストール</a></li><li><a href="#5">Apacheを停止</a></li><li><a href="#6">certbotを使って鍵を作成</a></li><li><a href="#7">Apacheに鍵のパスを記述</a></li><li><a href="#8">Apache 再起動</a></li><li><a href="#9">サブドメインでもLet's Encryptを使えるようにする</a></li><li><a href="#10">自動更新の設定</a></li><li><a href="#11">faviconでエラー</a></li><li><a href="#12">.htaccessでhttpsへリダイレクト</a></li></li></ul>
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/araemonz/20180729/20180729102849.jpg" class="default" /><br><br><h2 id="1">条件</h2>* Apacheのバージョンは2.2.15以上とする<br>* オレオレ証明書を既に使っている<br>* 443ポートは解放済み<br>* バーチャルホストで運営している<br>* CentOS 6.x<br><br>この条件で以下作業を行なっていく。<br>rootになって/rootディレクトリで操作した。<br><br><br><h2 id="2">手順</h2>1. certbotをダウンロード<br>2. Apacheを停止<br>3. certbotを使って鍵を作成<br>4. Apacheに鍵のパスを記述<br>5. Apacheを再起動<br>6. 自動更新の設定<br><br><br><h2 id="3">curlのアップデート</h2>**curlが古いとうまくいかないので事前にアップデートしておく。**<br><pre><br>yum update curl<br></pre><br><br><h2 id="4">certbotをインストール</h2><pre><br>git clone https://github.com/letsencrypt/letsencrypt<br></pre><br><br><h2 id="5">Apacheを停止</h2>Apacheを止めないと証明書を作れないので止めておく。<br><pre><br> /etc/rc.d/init.d/stop<br></pre><br><br><h2 id="6">certbotを使って鍵を作成</h2>いくつか質問されるが難しいことはない。<br><pre><br> cd letsencrypt<br><br>./letsencrypt-auto certonly -a standalone -d hogedomain.com<br></pre><br><br>/etc/letsencrypt/live/hogedomain.com/ 内に鍵が作られた<br><br><pre><br>   ls /etc/letsencrypt/live/hogedomain.com/<br>   README  cert.pem  chain.pem  fullchain.pem  privkey.pem<br></pre><br><br><h2 id="7">Apacheに鍵のパスを記述</h2>Apacheにこの鍵のパスを設定する。<br><br><pre><br>vi /etc/httpd/conf.d/ssl.conf<br><br>##以下を書き換える<br>SSLCertificateFile /etc/letsencrypt/live/hogedomain.com/fullchain.pem<br>SSLCertificateKeyFile /etc/letsencrypt/live/hogedomain.com/privkey.pem<br></pre><br><br><h2 id="8">Apache 再起動</h2>停止していたApacheを起動する。<br><br><pre><br>/etc/rc.d/init.d/httpd start<br></pre><br>これでルートドメインにSSL付きでアクセスできる。<br><br><h2 id="9">サブドメインでもLet's Encryptを使えるようにする</h2>サブドメイン毎に設定してやらなければならない。<br>やり方はルートドメインの時と同じ。<br><br><pre><br>./letsencrypt-auto certonly -a standalone -d sub.hogedomain.com<br></pre><br><pre><br>vi /etc/httpd/conf.d/virtualhost.conf<br><br>##以下を追加<br>&lt;VirtualHost *:443&gt;<br>    ServerName sub.hogedomain.com<br>    DocumentRoot /somewhere/hogedomain/sub<br><br>    SSLEngine on<br>    SSLCertificateFile /etc/letsencrypt/live/sub.hogedomain.com/fullchain.pem<br>    SSLCertificateKeyFile /etc/letsencrypt/live/sub.hogedomain.com/privkey.pem<br><br>    ErrorLog logs/sslvirtual_error_log<br>    CustomLog logs/sslvirtual_access_log combined env=!no_log<br>   NameVirtualhost *:443<br>&lt;/VirtualHost&gt;<br></pre><br><br><h2 id="10">自動更新の設定</h2>Let's Encryptは３ヶ月しか有効期限がないので、自動更新するとよい。更新のためのコマンドをcronする。<br>まず、下記のコマンドが正常に動作し、証明書が更新されるかをテスト。<br>renewは、すべての証明書を更新するコマンド。--post-hookオプションで指定したコマンドは、renew後に実行される。ただし、renewは期限が迫らないうちは、実行がスキップされ、その場合はpost-hookも実行されない。<br><a href="https://qiita.com/takahiko/items/a08895550727b95b6c36">https://qiita.com/takahiko/items/a08895550727b95b6c36</a><br><br>記事のように自動更新の設定をしていたのだが、なぜかその後に更新をしてくださいという内容のメールが来てしまった。<br><br><pre><br>Hello,<br><br>Your certificate (or certificates) for the names listed below will expire in 20 days (on 18 Aug 18 07:08 +0000). Please make sure to renew your certificate before then, or visitors to your website will encounter errors.<br><br>We recommend renewing certificates automatically when they have a third of their<br>total lifetime left. For Let's Encrypt's current 90-day certificates, that means<br>renewing 30 days before expiration. See<br><a href="https://letsencrypt.org/docs/integration-guide/ for details.">https://letsencrypt.org/docs/integration-guide/ for details.</a><br><br>hogehoge.com<br><br>For any questions or support, please visit https://community.letsencrypt.org/. Unfortunately, we can't provide support by email.<br><br>If you are receiving this email in error, unsubscribe at http://mandrillapp.com/track/unsub.php?u=30850198&id=e6af6ce87eeb49cab9f7c4584c8d49da.Xdoz7jXx662gLBduhGy%2FwZtnakk%3D&r=https%3A%2F%2Fmandrillapp.com%2Funsub%3Fmd_email%3Daraemonz%2540gmail.com<br><br>Regards,<br>The Let's Encrypt Team<br></pre><br>どうも、Apacheを停止してから更新処理をしていなかったのが原因のようだ。<br><br><pre><br>Saving debug log to /var/log/letsencrypt/letsencrypt.log<br><br>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br>Processing /etc/letsencrypt/renewal/hogehoge.com.conf<br>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br>Cert is due for renewal, auto-renewing...<br>Plugins selected: Authenticator standalone, Installer None<br>Renewing an existing certificate<br>Performing the following challenges:<br>tls-sni-01 challenge for hogehoge.com<br>Cleaning up challenges<br>Attempting to renew cert (hogehoge.com) from /etc/letsencrypt/renewal/hogehoge.com.conf produced an unexpected error: Problem binding to port 443: Could not bind to IPv4 or IPv6.. Skipping.<br></pre><br>ということで以下のようにcronに登録してみた。<br>毎月の7日、04時00分に実行する。<br><br><pre><br>vi /etc/cron.d/letsencrypt<br><br>00 04 01 * * root /etc/rc.d/init.d/httpd stop && /usr/bin/certbot-auto renew && /etc/rc.d/init.d/httpd start<br></pre><br><pre><br>分 時 日 月 曜日 <実行コマンド><br></pre><br><br><h2 id="11">faviconでエラー</h2>ブラウザーが小さい警告表示を出していた。<br>原因はfaviconだった。<br>ブラウザーがfaviconを勝手にリクエストするようで、faviconを設置していなかったためにhttpでリダイレクトエラーが出たということ。<br>faviconを設置して無事エラーはなくなった。<br><br><br><h2 id="12">.htaccessでhttpsへリダイレクト</h2>httpでアクセスしても自動でhttpsへリダイレクトするように.htaccessを編集。<br><br><pre><br>RewriteEngine On<br>RewriteCond %{HTTPS} off<br>RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]<br></pre></p>
        <ul class="shareList">
        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=http://192.168.100.101/blog/centos6-lets-encrypt.html&text=%F0%9F%92%BBCentOS+6.x+%E3%81%AB%E7%84%A1%E6%96%99SSL+Let%27s+Encrypt+%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B" target="_blank" title="Twitter"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="Facebook"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="Google+"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/http://192.168.100.101/blog/centos6-lets-encrypt.html" target="_blank" title="はてなブックマーク"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=http://192.168.100.101/blog/centos6-lets-encrypt.html&title=%F0%9F%92%BBCentOS+6.x+%E3%81%AB%E7%84%A1%E6%96%99SSL+Let%27s+Encrypt+%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B" target="_blank" title="Pocket"></a></li>
        </ul>

</article>
</div>
            </div>

<div id="page_top"><a href="#"></a></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
/****************************************
 * TOPへ戻るボタン表示
 ***************************************/
$(function() {
    var pagetop = $('#page_top');
    pagetop.hide();
    $(window).scroll(function () {
        if ($(this).scrollTop() > 100) {  //100pxスクロールしたら表示
            pagetop.fadeIn();
        } else {
            pagetop.fadeOut();
        }
    });
    pagetop.click(function () {
        $('body,html').animate({
            scrollTop: 0
        }, 300); //0.3秒かけてトップへ移動
        return false;
    });
});

</script>
</body>
</html>