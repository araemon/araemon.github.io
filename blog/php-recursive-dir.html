<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>
PHPでディレクトリにあるファイルを再帰的に探す処理</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta content="PHPでディレクトリにあるファイルを再帰的に探す処理" property="og:title" />
<meta content="article" property="og:type" />
<meta content="https://araemon.github.io/blog/php-recursive-dir.html" property="og:url" />
<meta content="https://araemon.github.io" property="og:image" />
<link rel="stylesheet" type="text/css" href="/css/icon.css"  />
<link rel="stylesheet" type="text/css" href="/css/main.css?1545034000"  />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-icon-144x144.jpg">
<link rel="shortcut icon" href="/images/favicon.ico">
</head>
<body>

        <div id="container">
        <div id="header" class="blog">
        <div class="layerTransparent">
                <div class="container">
                <ul class="nav">
<li><a href="/blog/">Blog</a></li>
<li><a href="/kamityping/">KamiTyping</a></li>
<li><a href="/chazuke/">Chazuke</a></li>
<li><a href="/harmonize/">Harmonize</a></li>
<li><a href="/apps/">Other Apps</a></li>
<li><a href="/about/">About</a></li>
</ul>
<div class="copyright">Copyright © Toshihiko Arai</div>
                </div>
</div>
        </div>

<div id="contents">
<article>
    <div class="tag">
    <a href="/blog/" class="tagHighlight">Blog (記事一覧)</a>
    </div>
<h1>
PHPでディレクトリにあるファイルを再帰的に探す処理</h1>
<div class="time"><time pubdate="" datetime="2018-12-17">
2018-12-17</time></div>
<p>

再帰的というのは、「鏡の中の鏡」、「GNU is Not Unix」のように自分自身を呼び出すことで、永遠と同じ処理を回すことができます。<br>下のプログラムの場合、recursiveOpenDirというfunctionの中で自分自身、つまりrecursiveOpenDirを呼び出しています。こうすることで永遠にディレクトリを探し続けることができます。<br>このプログラムはsitemapやRSSを作成する時などに応用することができます。また、拡張子の判定をjpgやpngに変えれば、画像処理も一括で行うことができます。<br><pre class='code'>&lt;?php
$rootDir = &quot;/somewheredir/&quot;;

recursiveOpenDir($rootDir);

function recursiveOpenDir($dir)
{
    $od = opendir($dir);
    if (!$od) {return;}

    while (false !== ($file = readdir($od))) {
        $array = explode('.', $file);
        if (count($array) == 1) { // $fileがディレクトリである
            recursiveOpenDir($dir . $file . &quot;/&quot;);
            continue;
        }
        if ($array[1] == &quot;html&quot;) {
            echo $dir . $file . &quot;\n&quot;;
        }
    }
}
</pre><br>このままでも十分ですが、せっかくですのでfunctionをclass化にすることでオブジェクトとして扱えるようにしたいと思いました。今までのPHPプログラミングでは、オブジェクティブ思考で考えてきませんでした。その場のやっつけ仕事でなんとかなってきたとも言えますが、Objective-Cやswift、kotlinなどでアプリケーション開発していると、PHPもオブジェクティブ思考で考えたくなります。その方が管理が楽ですし、資産化できると思いました。<br>上記のファンクションは、次のように書くことができました。<br><br><pre class='code'>&lt;?php
class RecursiveOpenObject
{
    public $path = &quot;&quot;;
    public $filename = &quot;&quot;;
    public $dist = &quot;&quot;;
}

class RecursiveOpen
{
    protected $baseDir;
    protected $extension;
    protected $filePaths;
    protected $excludes;

    public function __construct(string $baseDir, string $extension, array $excludes)
    {
        $this-&gt;baseDir = $baseDir;
        $this-&gt;extension = $extension;
        $this-&gt;filePaths = array();
        $this-&gt;excludes = $excludes;
        $this-&gt;openDir($this-&gt;baseDir);
    }
    public function files()
    {
        return $this-&gt;filePaths;
    }

    private function openDir($dir)
    {
        $od = opendir($dir);
        if (!$od) {return;}

        while (false !== ($file = readdir($od))) {
            $array = explode('.', $file);
            if (in_array($array[0], $this-&gt;excludes)) {
                continue;
            }
            if (count($array) == 1) { // $fileがディレクトリである
                $this-&gt;openDir($dir . $file . &quot;/&quot;);
                continue;
            }
            if ($array[1] == $this-&gt;extension) {
                $obj = new RecursiveOpenObject();
                $obj-&gt;path = $dir . $file;
                $obj-&gt;filename = $array[0];
                $obj-&gt;dist = preg_replace(&quot;{&quot; . $this-&gt;baseDir . &quot;}&quot;, &quot;&quot;, $dir);

                array_push($this-&gt;filePaths, $obj);
            }
        }

    }

}
</pre><br>使い方は次のようになります。コンストラクターの第一引数に、検索対象となるルートディレクトリを絶対パスで指定します。第二引数には探したいファイルの拡張子を指定してあげます。第三引数には配列で、除外したいファイルを指定できるようにしてみました。インスタンス生成後、filesメソッドを呼び出すことで、RecursiveOpenObject配列を返してくれます。ちなみにRecursiveOpenObjectのdistというのは、最初に渡したルートディレクトリ以降のディレクトリを返してくれます。<br><pre class='code'>$rootDir = &quot;/somewheredir/&quot;;
$recursive = new RecursiveOpen($rootDir, &quot;md&quot;, array(&quot;sample&quot;));
foreach ($recursive-&gt;files() as $obj) {
    echo $obj-&gt;path.PHP_EOL;
    echo $obj-&gt;filename.PHP_EOL;
    echo $obj-&gt;dist.PHP_EOL;
}
</pre><br><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/QtFPdBUl7XQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><br><br><a target="_blank"  href="https://www.amazon.co.jp/gp/product/B000YPWBQ2/ref=as_li_tl?ie=UTF8&camp=247&creative=1211&creativeASIN=B000YPWBQ2&linkCode=as2&tag=101010fun-22&linkId=6f89addad87e5c014baa8a352661c0fd"><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B000YPWBQ2&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=101010fun-22" ></a><img src="//ir-jp.amazon-adsystem.com/e/ir?t=101010fun-22&l=am2&o=9&a=B000YPWBQ2" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
        <ul class="shareList">
        <li class="shareList__item"><a class="shareList__link icon-twitter" href="https://twitter.com/intent/tweet?url=https://araemon.github.io/blog/php-recursive-dir.html&text=PHP%E3%81%A7%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%AB%E3%81%82%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%86%8D%E5%B8%B0%E7%9A%84%E3%81%AB%E6%8E%A2%E3%81%99%E5%87%A6%E7%90%86" target="_blank" title="Twitter"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://araemon.github.io/blog/php-recursive-dir.html" target="_blank" title="Facebook"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-google-plus" href="https://plus.google.com/share?url=https://araemon.github.io/blog/php-recursive-dir.html" target="_blank" title="Google+"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-hatebu" href="http://b.hatena.ne.jp/entry/https://araemon.github.io/blog/php-recursive-dir.html" target="_blank" title="はてなブックマーク"></a></li>
        <li class="shareList__item"><a class="shareList__link icon-pocket" href="http://getpocket.com/edit?url=https://araemon.github.io/blog/php-recursive-dir.html&title=PHP%E3%81%A7%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%81%AB%E3%81%82%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%86%8D%E5%B8%B0%E7%9A%84%E3%81%AB%E6%8E%A2%E3%81%99%E5%87%A6%E7%90%86" target="_blank" title="Pocket"></a></li>
        </ul>
<ul id="prevNext">
<li class="prev">
<a href="mac-mecab.html">&lt; MeCabで形態素解析</a></li><li class="next"></li></ul>
</article>
</div>
            </div>
<script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
<script>
/****************************************
 * Lazy Load
***************************************/
lazyload();

</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-12032595-16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-12032595-16');
</script>

</body>
</html>